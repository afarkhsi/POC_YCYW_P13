<div
  style="
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #f3f4f6;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  "
>
  <!-- HEADER -->
  <div
    style="
 background: 
  linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
  url('assets/banner.png') center center / cover no-repeat;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    "
  >
    <div style="display: flex; align-items: center; gap: 12px">
      <div>
        <div style="color: white; font-weight: 700; font-size: 16px">Your Car Your Way</div>
        <div style="color: #94a3b8; font-size: 12px">
          {{ conversationId ? 'Conversation #' + conversationId : 'Support Chat' }}
        </div>
      </div>
    </div>

    <div style="display: flex; align-items: center; gap: 12px">
      <div style="text-align: right">
        <div style="color: white; font-size: 14px; font-weight: 600">
          {{ currentUser?.firstname }} {{ currentUser?.lastname }}
        </div>
        <div
          [ngStyle]="{ background: currentUser?.type === 'CLIENT' ? '#10b981' : '#e94560' }"
          style="
            display: inline-block;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 11px;
            color: white;
            font-weight: 600;
          "
        >
          {{ currentUser?.type }}
        </div>
      </div>
      <!-- Bouton retour â€” visible uniquement pour l'agent en conversation -->
      <button
        *ngIf="currentUser?.type === 'AGENT_SUPPORT' && conversationId"
        (click)="leaveConversation()"
        style="
          padding: 8px 16px;
          background: rgba(255, 255, 255, 0.1);
          color: white;
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 8px;
          cursor: pointer;
          font-size: 13px;
          margin-right: 8px;
        "
      >
        â†
      </button>

      <button
        (click)="logout()"
        style="
          padding: 8px 16px;
          background: rgba(255, 255, 255, 0.1);
          color: white;
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 8px;
          cursor: pointer;
          font-size: 13px;
        "
      >
        DÃ©connexion
      </button>
    </div>
  </div>

  <!-- affichage global des erreurs -->
  <div
    *ngIf="errorMessage"
    style="
      background: #fef2f2;
      color: #dc2626;
      padding: 10px 24px;
      font-size: 13px;
      border-bottom: 1px solid #fecaca;
      display: flex;
      justify-content: space-between;
      align-items: center;
    "
  >
    âš ï¸ {{ errorMessage }}
    <span (click)="errorMessage = ''" style="cursor: pointer; font-size: 18px; color: #dc2626"
      >âœ•</span
    >
  </div>

  <!-- Ã©tat de chargement pendant la connexion -->
  <div
    *ngIf="isConnecting"
    style="text-align: center; padding: 40px; color: #6b7280; font-size: 14px"
  >
    â³ Connexion en cours...
  </div>

  <!-- VUE AGENT -->
  <div
    *ngIf="currentUser?.type === 'AGENT_SUPPORT' && !conversationId && !isConnecting"
    style="max-width: 700px; width: 100%; margin: 32px auto; padding: 0 24px"
  >
    <!-- Conversations en attente -->
    <div
      style="
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      "
    >
      <h3 style="margin: 0 0 16px; color: #1a1a2e; font-size: 16px; font-weight: 700">
        ğŸ• Conversations en attente
      </h3>
      <div
        *ngIf="pendingConversations.length === 0"
        style="text-align: center; padding: 24px; color: #9ca3af; font-size: 14px"
      >
        Aucune conversation en attente.
      </div>
      <div
        *ngFor="let conv of pendingConversations"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 14px 16px;
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          margin-bottom: 8px;
          background: #f9fafb;
        "
      >
        <div>
          <div style="font-weight: 600; color: #1a1a2e; font-size: 14px">
            Conversation #{{ conv.id }}
          </div>
          <div style="color: #6b7280; font-size: 13px">
            ğŸ‘¤ {{ conv.customer?.firstname }} {{ conv.customer?.lastname }}
          </div>
        </div>
        <button
          (click)="joinConversation(conv.id)"
          style="
            padding: 8px 18px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
          "
        >
          Rejoindre â†’
        </button>
      </div>
    </div>

    <!-- Mes conversations -->
    <div
      style="
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      "
    >
      <h3 style="margin: 0 0 16px; color: #1a1a2e; font-size: 16px; font-weight: 700">
        ğŸ’¼ Mes conversations
      </h3>
      <div
        *ngIf="myConversations.length === 0"
        style="text-align: center; padding: 24px; color: #9ca3af; font-size: 14px"
      >
        Aucune conversation assignÃ©e.
      </div>
      <div
        *ngFor="let conv of myConversations"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 14px 16px;
          border: 1px solid #dbeafe;
          border-radius: 10px;
          margin-bottom: 8px;
          background: #eff6ff;
        "
      >
        <div>
          <div style="font-weight: 600; color: #1a1a2e; font-size: 14px">
            Conversation #{{ conv.id }}
          </div>
          <div style="color: #6b7280; font-size: 13px">
            ğŸ‘¤ {{ conv.customer?.firstname }} {{ conv.customer?.lastname }}
          </div>
        </div>
        <!-- "Reprendre" appelle resumeConversation, pas joinConversation
             (Ã©vite d'appeler assignAgent sur une conversation dÃ©jÃ  assignÃ©e) -->
        <button
          (click)="resumeConversation(conv.id)"
          style="
            padding: 8px 18px;
            background: #0f3460;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
          "
        >
          Reprendre â†’
        </button>
      </div>
    </div>
  </div>

  <!-- VUE CHAT -->
  <div
    *ngIf="conversationId && !isConnecting"
    style="
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
      overflow: hidden;
    "
  >
    <!--  #messagesContainer pour l'auto-scroll -->
    <div
      #messagesContainer
      style="
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 16px;
      "
    >
      <div
        *ngIf="messages.length === 0"
        style="text-align: center; padding: 40px; color: #9ca3af; font-size: 14px"
      >
        ğŸ’¬ Aucun message pour l'instant. Commencez la conversation !
      </div>

      <div
        *ngFor="let msg of messages"
        style="display: flex; margin-bottom: 16px"
        [ngStyle]="{
          'flex-direction': msg.senderId === currentUser?.userId ? 'row-reverse' : 'row',
        }"
      >
        <!-- Avatar -->
        <div
          [ngStyle]="{
            background:
              msg.senderId === currentUser?.userId
                ? 'linear-gradient(135deg, #0f3460, #e94560)'
                : 'linear-gradient(135deg, #10b981, #059669)',
            margin: msg.senderId === currentUser?.userId ? '0 0 0 10px' : '0 10px 0 0',
          }"
          style="
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 700;
          "
        >
          {{ msg.senderName?.charAt(0) }}
        </div>

        <!-- Bulle -->
        <div style="max-width: 65%">
          <div
            style="font-size: 11px; color: #9ca3af; margin-bottom: 4px"
            [ngStyle]="{ 'text-align': msg.senderId === currentUser?.userId ? 'right' : 'left' }"
          >
            {{ msg.senderName }} Â· {{ msg.createdAt | date: 'HH:mm' }}
          </div>
          <div
            [ngStyle]="{
              background:
                msg.senderId === currentUser?.userId
                  ? 'linear-gradient(135deg, #0f3460, #1e4d8c)'
                  : '#f3f4f6',
              color: msg.senderId === currentUser?.userId ? 'white' : '#1a1a2e',
              'border-bottom-right-radius': msg.senderId === currentUser?.userId ? '4px' : '16px',
              'border-bottom-left-radius': msg.senderId === currentUser?.userId ? '16px' : '4px',
            }"
            style="
              padding: 12px 16px;
              border-radius: 16px;
              font-size: 14px;
              line-height: 1.5;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            "
          >
            {{ msg.message }}
          </div>
        </div>
      </div>
    </div>

    <!-- Zone saisie -->
    <div
      style="
        display: flex;
        gap: 12px;
        align-items: center;
        background: white;
        padding: 16px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      "
    >
      <input
        type="text"
        [(ngModel)]="newMessage"
        (keyup.enter)="sendMessage()"
        placeholder="Tapez votre message..."
        style="
          flex: 1;
          padding: 12px 16px;
          border: 2px solid #e5e7eb;
          border-radius: 10px;
          font-size: 14px;
          outline: none;
          box-sizing: border-box;
        "
      />
      <button
        (click)="sendMessage()"
        [disabled]="!newMessage.trim()"
        style="
          padding: 12px 24px;
          background: linear-gradient(135deg, #0f3460, #e94560);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        "
        [style.opacity]="!newMessage.trim() ? '0.5' : '1'"
        [style.cursor]="!newMessage.trim() ? 'not-allowed' : 'pointer'"
      >
        Envoyer âœˆï¸
      </button>
    </div>
  </div>
</div>
